%!TEX root = thesis.tex
\chapter{Magnetic and electromagnetic forces}
\chaplabel{magnet-theory}

\epigraph{With an eye to the practical importance of levitation we
feel justified here in disregarding those aspects of it
associated with magic, spiritualism, and psychic
phenomena\dots}{\textcite{boerdijk1956b}}

\chapterprecis{
  This is the most analytical of the theory/literature sections, since it is
  here that I present and abstract a body of work that deals with `forces
  between magnets', also including some quick mentions of magnetic field
  theory and some associated concepts (such as eddy current damping).
}


\referpaper{The work presented in \secref{cylforces} is based on material that has been published as a journal paper~\cite{robertson2011-ietm}.}

\section{Magnetic fields}

It's instructive but misleading to think about magnetic fields
`squashing' as they come in proximity to each other. Just ask
\textcite{sodano2006} who received comments nitpicking comments about
their terminology \cite{marneffe2007}.

\section{Sources of the magnetic field}
\seclabel{bhm}

Magnetic fields are created by moving electrons. A long straight wire
will create cylindrical magnet fields, and a small loop will create a
magnetic dipole. Thus, an electron orbiting a proton is the smallest
magnetic element.  This is a hydrogen atom. In nature, however,
hydrogen exists as H$_2$, two protons orbited by two electrons---and
it happens that the two electrons orbit in opposite directions and the
magnetic fields of each cancel each other out.  Most material is like
this: basically, not magnetic.

The following is a very short introduction to the physics behind
magnets. A good reference book which inspired this section is
\textcite{campbell1994}.

The \define{magnetic dipole} is designated as the microscopic quantity
$\mdip = i\vect{A}$, for a current $i$ and a vector area $\vect{A}$
(direction normal to plane). For a collection of magnetic dipoles (as
in a permanent magnet), their net effect may be quantified with the
macroscopic \emph{magnetisation} of the material, $\magM$:
\begin{dmath}
  \magM =  \lim_{\Delta V \rightarrow 0} \frac{\sum \mdip}{\Delta V}.  \eqlabel{M}
\end{dmath}

The magnetisation of a permanent magnet creates the magnetic fields
that are of such great interest. \emph{Inside} the magnet (with no
other external fields present), the magnetic field, $\magB$, is given by
the simple relation
\begin{dmath}[label=BM]
  \magB = \permVac \magM
\end{dmath},
where $\permVac$ is the `permeability of the vacuum', an essentially
meaningless name given to the necessary constant of proportionality.

So, macroscopic magnetic fields have been derived from microscopic
currents. It is possible to take this full circle and now create
macroscopic current terms from the magnetic field. The equivalent
current density, $\vect{J}_m$ around a permanent magnet, created by
aligned microscopic orbiting electrons is given by:
\begin{dmath}
  \vect{J}_m = \curl\magM.
\end{dmath}
This is a good beginning for describing the effects of an \emph{external}
current density ($\vect{J}$) acting on the magnet. To separate the effects of
induced magnetisation and that caused spontaneously by magnetic material, a
new term is created: the magnetic field strength, $H$:
\begin{dmath}
  \vect{J} = \curl\magH.
\end{dmath}
Now the earlier \eqref{BM} can be adjusted to allow for both
internal and external forms of magnetisation (\ie, magnetic field
caused by permanent magnets or by current carrying conductors). This
is the fundamental equation relating the three important terms in
magnetics,
\begin{dmath}
  \magB = \permVac (\magM + \magH)  \eqlabel{BHM}
\end{dmath},
allowing the terms to be unambiguously defined. Henceforth, $\magB$ is
called the \define{magnetic flux density}, which a measure of the
total flux per area; and $\magH$ is the \define{magnetic field strength},
the effect of external current sources that creates the magnetic
field.
\note{The names of these terms are not always consistent in the
  literature. $\magM$ is also known as polarisation, and $\magB$ and $\magH$
  are both sometimes known as the magnetic field.}

Finally, the \define{permeability} $\perm$ of a material (generally
only used when the material is not a permanent magnet) is a varying
term describing the ratio between the magnitudes of the $\magB$ and $\magH$
fields. The \define{relative permeability} $\permrel$ is the ratio of
the permeability to $\permVac$.
\begin{dgroup}
  \begin{dmath}
    \perm = \frac{B}{H}
  \end{dmath},
  \begin{dmath}
    \permrel = \frac{\perm}{\permVac}
  \end{dmath}.
\end{dgroup}
\Eqref{BHM}, may now be used to describe the situation at all
points in space. Use \figref{BHM} to note that while inside the
magnet, the magnetic field is the vector sum of two components,
whereas outside the magnet, the magnetisation is zero and the magnetic
field is related to the magnetic field strength by a constant. This
results in $\magB$ being continuous everywhere, and both $\magM$~and $\magH$
being discontinuous.

\begin{figure}[htbp]
   \centering
   \grf{Figures/Theory/BHM}
   \caption{The magnetic field, $\magB$, both inside and outside a magnet.}
   \figlabel{BHM}
\end{figure}

This equivalence in air is essentially the reason that there is often
confusion between $\magB$ and $\magH$. It can be seen that within a magnet,
however, their relationship is more complex and important. The
performance of a magnet is shown by its \bhcurve/, which is shown for
an ideal magnet in \figref{BHcurve}. This curve demonstrates the
nonlinear and hysteresic effects of the magnetic flux density of a
magnetic material as external magnetic field is applied to it.

Two important features are shown in the \bhcurve/. First, the
\define{remanence} of the magnet, $B_r$. This value is equal to
$\permVac\Msat$ and occurs when there is no external
magnetic field. The other is the \define{coercive force}, $H_c$, which
is the amount of magnetic field strength required to reduce the flux
density of the magnet to zero.

\begin{figure}[htbp]
   \centering
   \grf{Figures/Theory/BHcurve}
   \caption{The characteristic $B$ \vs\ $H$ curves for an ideal rare-earth magnet.}
   \figlabel{BHcurve}
\end{figure}

When the magnet is applying energy, it is operating in the second
quadrant of its \bhcurve/, \ie, the section of the curve between the
point of remanence and the coercive force, known as the
\define{demagnetisation curve}. This is because the energy used for
the demagnetisation is being taken by the causes of the
demagnetisation. At some point in this second quadrant, $-\magB\times\magH$
will have a maximum. Since this is proportional to the energy
potential, this is known as the \define{maximum energy product}
$\BHmax$, and can be shown to be equal in an ideal magnet to:
\begin{dmath}
  -\BHmax = \frac{\Msat}{2}
\end{dmath}
The potential energy of the magnet is thus directly related to its
magnetisation.

The constitutive relation for rare earth magnets, assuming a
high coercivity, is given by \textcite{nagaraj1988}
\begin{dmath*}
  \magB = \permVac\magH + \magM ,
\end{dmath*}
assuming that the air approximates a vacuum (magnetically) and the
relative permeability of the magnet is unity.


\section{Properties of magnetic flux}
\seclabel{flux}

The previous section introduced $\magB$, the magnetic flux density. An
analysis of how to derive the paths of magnetic flux is a little
beyond the scope of this document, but it is important to discuss the
flux lines themselves.

`Magnetic flux' derives its name from archaic models of magnetism,
whose proponents believed in the literal flow of a magnetic fluid
called the `luminiferous æther'. Nowadays, scientists tend toward more
modern interpretations using electromagnetic fields involving quantum
theory. Nonetheless, the name sticks. Magnetic flux, $\flux$, is
therefore defined as the amount of `fluid' passing through an area:
\begin{dmath}
  \flux = \magB \cdot A
\end{dmath}
This flux is almost analogous to electric current; the only difference
being that electric current is constrained by the conductor it is
flowing through, whereas while magnetic flux is known to \emph{prefer}
areas of greater permeability, it occasionally can deviate from these
simple paths

It is more instructive for a basic understanding of how magnets behave
to look at the ways their flux lines interact. The following `magnet
design axioms' are adapted from \textcite{moskowitz1995}, whose book
covers permanent magnet design for a wide range of uses.

\begin{enumerate}
\item Flux lines follow the path of least resistance. This means that they will
travel through the shortest path possible,
through the material with the
\emph{greatest} permeability---so they will travel more readily through
magnetic or ferrous material than air, and more readily through air
(although only slightly) than diamagnetic material.

\item Flux lines travelling in the same direction repel each other. This means
flux lines will never cross.

\item Flux lines enter ferrous material at right angles.

\item Permeability of ferrous material is `used up' by flowing flux; when the
material reaches saturation, flux lines travel as easy though air as through
the saturated material.

\item Flux lines travel from North to South poles in closed loops.

\item Magnets are made up of a very large number of unit poles.
\end{enumerate}

From these axioms, one can generate incorrect, yet applicable,
theories how and why magnets attract and repel each other. For
example, two magnets in repulsion have flux lines opposing each
other. It can be imagined that the reason forces occur between them is
due to a `squashing' of the flux lines which the magnets try to
oppose---but theories like this only help visualising magnetic
behaviour, \emph{not} for explaining the reasons behind it.

\section{Magnetic materials}

There are several materials from which permanent magnets can be
made. Short attention will be placed on the cheaper, legacy magnetic
materials such as the ferrite magnets and alnico magnets due to their
poor performance. Rare-earth neodymium magnets are now quite
commonplace and rather cheap, and have much more desirable properties
than these old fashioned magnets.

\Tabref{magnets} shows some approximate ranges comparing the
properties of the various magnet types available. Clearly, rare earth
magnets are capable of much greater energy output, and their high
coercivity precludes them from losing their magnetisation through
physical impact or proximity with other magnets---unlike the older
ferrite and alnico magnets. Their only disadvantage is their low
operating temperatures that perhaps will be inconvenient using them
for biased, or hybrid, electromagnets, in which a current carrying
coil is wrapped around a permanent magnet to increase the output of
magnetic field.

\begin{table}
  \centering
  \begin{tabular}{@{} l r@{\,--\,}l r@{\,--\,}l r@{\,--\,}l @{}}
    \toprule
    & \multicolumn{6}{c}{Magnet type}\\
    \cmidrule{2-6}
    Property            & \multicolumn{2}{c}{Ferrite}
                        & \multicolumn{2}{c}{Alnico}
                        & \multicolumn{2}{c}{Neodymium}  \\
    \midrule
    Max.\ temperature (°C)    & \num{400} & \num{500} & \num{800} & \num{900} &    \num{ 80} & \num{200}  \\
    Remanence (T)             & \num{0.2} & \num{0.4} & \num{0.5} & \num{1.3} &    \num{  1} & \num{1.3}  \\
    Coercivity (\si{kA/m})    & \num{100} & \num{200} & \num{50 } & \num{160} & ~~~\num{800} & \num{900}  \\
    Max.\ energy product
               (\si{kJ/m^3})  & \num{6}   & \num{33}  & \num{10}  & \num{80}  &    \num{200} & \num{300}  \\
    \bottomrule
  \end{tabular}
  \caption[Typical values for various permanent magnets.]
  {Typical values for various permanent magnets.
   Adapted from information from \url{http://www.magtech.com.hk/}.}
  \tablabel{magnets}
\end{table}


\section{Assorted}


The remanence magnetisation is calculated from the nominal energy
product of the magnets \cite{campbell1994}. The nominal energy product
$\BHmax$ is related to the saturation magnetisation by
\begin{dmath}
\BHmax = \permVac\gp{\half \Msat}^2,
\end{dmath}
which can be used to calculate the remanence with the relation
$\remanence=\permVac\Msat$:
\begin{dmath}
\remanence=\sqrt{4\permVac\BHmax}=\SI{1.39}{T}.
\end{dmath}



\section{Analytical expressions for the magnetic field}

New publications on the analytic magnetic field equation for a thick coil appear to be being published at an accelerating rate \cite{danilov1971-nim,urankar1982-ietm,azzerboni1993-ietm,labinac2006-ajp,pechenkov2006-rndt,ravaud2010-emwaves}.

Magnetic field from pyramidal frustrum magnets: \cite{compter2010-ietm}


\section{Forces between magnets}

Force between single-turn circular coils \cite{babic2008-ietm,shiri2009-pier} can be used in the `filament method' \cite[also see]{akyel2009-pier}.

For fast magnetic field computation, the `fast multipole method' can
be used \cite{adedoyin2007}. But I haven't used it.

Magnetic fields can induce forces through a variety of
methods. Electromagnetic actuators often use Lorentz forces
\cite{hollis1993}.

\textcite{bassani2006-meccanica}

A general technique for finding the forces between two magnets is
simple to describe. The first magnet creates a magnetic field in the
region of the second magnet; the force is calculated due to the
interaction of the first magnet's field and the internal field of the
second magnet. Or vice versa; reciprocity holds here.

The magnetic field due to a magnet can be calculated by modelling the
magnet either as a body containing a current density or containing
some magnetic charge. Rare-earth magnets have the convenient property
of high coercivity that prevents demagnetisation; hence, assumptions
of a fixed and volume-constant magnetisation hold very well.

In the first step, the integration takes place over the region of the
first magnet:
\begin{dmath}
\magB_1\fn{\pos_2} =
  \magconst\Int{
    \gp{-\Div\magM_1}
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}}{v_1,V_1}
+ \magconst\oint\limits_{S_1}
    \gp{\magM_1\dotprod\normn}
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
    \dee s_1
\end{dmath}.

In the second step, the integration of the function of the magnetic
field of the first magnet takes place over the region of the second
magnet:
\begin{dmath}
\force =
  \int\limits_{V_2}
  \gp{-\Div\magM_2}
  \magB_1\fn{\pos_2} \dee v_2
+ \oint\limits_{S_2}
  \gp{\magM_2\dotprod\normn}
  \magB_1\fn{\pos_2} \dee s_2
\end{dmath}.

Torque is similar.
\begin{dmath}
\torque =
  \int\limits_{V_2}
  \gp{-\Div\magM_2}
  \gp{  \lever\crossprod\magB_1\fn{\pos_2} } \dee v_2
+ \oint\limits_{S_2}
  \gp{  \magM_2\dotprod\normn       }
  \gp{  \lever\crossprod\magB_1\fn{\pos_2} } \dee s_2
\end{dmath}.

The volume integrals contain $\Div\magM$ terms, which will equal zero
in the regions of constant magnetisation within the regions of the
magnetic volumes. This is a reasonable assumption for modern rare
earth magnetic material. The equations above can therefore be
simplified.

\begin{dmath}
\magB_1\fn{\pos_2} =
  \magconst\oint\limits_{S_1}
    \gp{  \magM_1\dotprod\normn  }
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
    \dee s_1
\end{dmath},
\begin{dmath}
\force =
  \oint\limits_{S_2}
  \gp{  \magM_2\dotprod\normn  }
  \magB_1\fn{\pos_2} \dee s_2
= \magconst
  \oint\limits_{S_2}
  \oint\limits_{S_1}
    \gp{  \magM_1\dotprod\normn_{s_1}  }
    \gp{  \magM_2\dotprod\normn_{s_2}  }
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
    \dee s_1
  \dee s_2
\end{dmath},
\begin{dmath}
\torque =
  \oint\limits_{S_2}
    \gp{  \magM_2\dotprod\normn       }
    \gp{  \lever\crossprod\magB_1\fn{\pos_2} }
  \dee s_2
 =
  \magconst
  \oint\limits_{S_2}
    \gp{  \magM_2 \dotprod \normn_{s_2} }
    \gp{
      \lever\crossprod
      \gp{
        \oint\limits_{S_1}
          \gp{  \magM_1\dotprod\normn_{s_1}  }
          \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
        \dee s_1
      }
    }
  \dee s_2
\end{dmath}.

\subsection{Analytical force expressions}

Expressions for the forces between magnets follow directly from
Maxwell's equations, and may be derived in a number of ways.


\section{(Anti-)parallel cuboid magnets}

\def\e#1{e_#1}

A variety of analytical solutions have been developed to calculate the
force between cuboid-shaped magnets with parallel/anti-parallel
magnetisations \cite{akoun1984,nagaraj1988,bonisoli2006}. More complex
geometries can be realised through superposition of the solutions
\cite{bancel1999}.


\subsection{Forces between magnets}

The notation for the models to calculate the forces between cuboid magnets is as follows, with the geometry of the system depicted graphically in \figref{akoun}.
The first magnet has dimensions $[2a, 2b, 2c]\T$ and the second magnet has dimensions $[2A, 2B, 2C]\T$.
The distance between their centres is given by $\bm d=[\alpha,\beta,\gamma]\T$.
The magnetisations of the magnets are assumed to be constant and aligned in the $z$-direction (`facing up').
Negative magnetisation corresponds to a magnet `facing down' and results in forces of reversed sign.

The original expression for the forces between magnets is shown again here as terms within will be referred to later. It is compactly written as six nested summations of intermediate expressions in $x$, $y$, and $z$ directions:
\begin{equation}\eqlabel{akoun}
\bm F_{z,z} = \frac{J_1 J_2}{4\pi\mu_0}
  \sum_{i,j,k,l,p,q\in\{0,1\}^6}
  \hspace{-5mm}% space hack
  \bm \phi\fn{\bm \delta_{i,j,k,l,p,q}}
  \cdot
  \gp{-1}^{i+j+k+l+p+q} ,
\end{equation}
where $\bm\phi(\bm\delta) = [\phi_x(\bm\delta),\phi_y(\bm\delta),\phi_z(\bm\delta)]\T$ will be given later.
The $(z,z)$ subscript refers to the directions of magnetisation of the magnets.
Force calculations for magnets oriented in the $x$ or $y$ directions can be found using a coordinate system transformation on \eqref{akoun}.

This form of \eqref{akoun} arises as it is derived from six nested direct integrals.
Rather than expanding the limits of each integral, the following summation notation is used instead; say $f$ integrates to $F$:
\begin{equation}
\int_{-a}^{a}
f(x) \dee x = F(a)-F(-a) =
\!\!\! % space hack
\sum_{i\in\{0,1\}} F(a\gp{-1}^i)\cdot \gp{-1}^i  .
\end{equation}
And therefore for multiple integrations:
\begin{dmath}
\Int{ f\fn{x,y,z} } {x,x_0,x_1} {y,y_0,y_1} {z,z_0,z_1}=
  \sum_{i,j,k\in\{0,1\}^3} F\fn{x_i,y_j,z_k}\cdot\gp{-1}^{i+j+k}
\end{dmath}
For $N$ nested integrals, it may be convenient to express this in a product form instead where $f$ is integrated over variables $x_i$ from $u_i\fn{1}$ to $u_i\fn{-1}$:
\begin{dmath}
\Int{ f\fn{x_1,x_2,\dots} }{x_1}{x_2} \cdots =
  \sum_{e_1,e_2,\dots\in\{1,-1\}^N}
    \gp{ F\fn{u_1\fn{e_1},u_2\fn{e_2},\dots}\prod_{n=1}^{N} e_n }
\end{dmath}

As the limits of the integral occur at the corners of the cuboid magnets, $\bm \phi$ is an intermediate function acting between each combination of corners between the first and second magnet.
Bancel \cite{bancel1999} used this fact to invent an abstraction for these expressions known as `magnetic nodes' calling what has been written above as $\bm\phi\fn{\bm \delta_{i,j,k,l,p,q}}\cdot\gp{-1}^{i+j+k+l+p+q}$ as the `force' between two magnetic nodes $(i,k,p)$ and $(j,l,q)$.
Summing the magnetic node forces between every combination of corners of the first and second magnet yields the total force between them.
This abstraction allows a reduction in the number of calculations required when magnetic nodes overlap; i.e., when calculating the forces between arrays of touching magnets.

The distance between two corners/nodes of two respective magnets, $\bm\delta_{i,j,k,l,p,q}=[u_{i,j}, v_{k,l}, w_{p,q}]\T$, is given by the distance between the magnet centres, $\bm d$, plus and minus the distance between the magnet centre and corner position for the second magnet, $\bm R$ and for the first magnet $\bm r$:
\begin{equation}
\bm\delta_{i,j,k,l,p,q}=\bm d+\bm R_{j,l,q} - \bm r_{i,k,p} ~,
\end{equation}
where
\begin{align}
\bm R_{j,l,q}&=\begin{bmatrix}A\gp{-1}^j\\B\gp{-1}^l\\C\gp{-1}^q\end{bmatrix},&
\bm r_{i,k,p}&=\begin{bmatrix}a\gp{-1}^i\\b\gp{-1}^k\\c\gp{-1}^p\end{bmatrix}.
\end{align}
Complete expressions for the corner distances are therefore:
\begin{dmath}[compact]
\bm \delta_{i,j,k,l,p,q}=\begin{bmatrix}u_{i,j}\\v_{k,l}\\w_{p,q}\end{bmatrix}=
\begin{bmatrix}
  \alpha-a\gp{-1}^i+A\gp{-1}^j\\
  \beta-b\gp{-1}^k+B\gp{-1}^l\\
  \gamma-c\gp{-1}^p+C\gp{-1}^q
\end{bmatrix}
\end{dmath}.
The $\bm\phi$ terms required for calculating the `force between nodes' can now be written, where $r=\sqrt{u^2+v^2+w^2}$, as:
\begin{dmath}
\bm\phi\fn{\bm \delta} =
\begin{bmatrix}
\half\gp{v^2-w^2}\Log{r-u}+uv\Log{r-v}+vw\ArcTan{\tfrac{uv}{rw}}+\half ru \\
\half\gp{u^2-w^2}\Log{r-v}+uv\Log{r-u}+uw\ArcTan{\tfrac{uv}{rw}}+\half rv \\
-uw\Log{r-u}-vw\Log{r-v}+uv\ArcTan{\tfrac{uv}{rw}}-rw
\end{bmatrix}
\end{dmath}
Note that when evaluating these functions numerically, two singularities must be accounted for:
\begin{align}
\lim_{x\to 0} x \log x &= 0 , & \lim_{x\to 0} \arctan(x/x) &= 0.
\end{align}

The stiffness characteristics can be derived by differentiating \eqref{akoun} with respect to displacement in each respective direction, resulting in
\begin{dmath}[label=akounk]
\vect K_{z,z} = \frac{JJ'}{4\pi\permVac} \sum_{(i,j,k,l,p,q)\in\{0,1\}^6} \vect k\fn{u_{ij},v_{kl},w_{pq},r}
\cdot \gp{-1}^{i+j+k+l+p+q} ,
\end{dmath}
where
\begin{dmath}
\bm k =
\begin{bmatrix}
-\frac{v u^2}{u^2+w^2}-r-v \Log{r-v} \\
-\frac{u v^2}{v^2+w^2}-r-u \Log{r-u} \\
 \frac{v w^2}{u^2+w^2}
  + \frac{u w^2}{v^2+w^2}
  + 2r+u\Log{r-u}+v \Log{r-v}
\end{bmatrix}
\end{dmath}
Note that the result $K_x+K_y+K_z=0$ follows from Earnshaw's theorem
\cite{earnshaw1842} following from the solution to Laplace's equation.

Allag and Yonnet \cite{allag2009-ietm} have published a description of how torques between cuboid magnets may be analytically calculated in a similar manner.
It is instructive to analyse their approach to the theory used to derive these equations, as it will be shown below that it is incorrect.
A short time after this paper was published a separate research group published the \emph{correct} equation \cite{janssen2010-ietm} for calculating torques between (anti-)parallel magnets.

The assertion given by Allag and Yonnet is that since the `forces' between the nodes of the magnets can be calculated, these corner forces can be used to calculate the applied torque on the magnets. Their expression for the torque (on the second magnet) can be written as per the style above in the following form.
\begin{equation}\eqlabel{torque}
\bm T_{z,z}=\frac{J_1 J_2}{4\pi\mu_0}
  \sum_{i,j,k,l,p,q\in\{0,1\}^6}
  \bm\psi_{i,j,k,l,p,q}
  \cdot
  \gp{-1}^{i+j+k+l+p+q} ,
\end{equation}
where
\begin{equation}
\bm\psi_{i,j,k,l,p,q} = \bm R_{j,l,q}\bm\times \bm \phi\fn{\bm \delta_{i,j,k,l,p,q}} .
\eqlabel{torque-inner}
\end{equation}
The interpretation of \eqref{torque} and \eqref{torque-inner} is that the inner terms of the summation represent the torque applied on the second magnet due to the influence of one corner of the first magnet and one corner of the second magnet. Allag and Yonnet write this slightly differently in terms of the total torque applied from the entire first magnet on each corner of the second:
\begin{equation}\label{torqu-1}
\bm T = \sum_{j,l,q\in\{0,1\}^3} \bm R_{j,l,q}\bm\times \bm f_{j,l,q} ,
\end{equation}
where $\bm f_{j,l,q}$ is the summed force on a corner of the second magnet due to every corner of the first magnet, given by
\begin{equation}\label{torqu-2}
\bm f_{j,l,q}=\tfrac{J_1 J_2}{4\pi\mu_0}
  \!\!\!\sum_{i,k,p\in\{0,1\}^3}\!\!\!
  \bm\phi\fn{\bm d_{i,j,k,l,p,q}}
  \cdot
  \gp{-1}^{i+j+k+l+p+q}.
\end{equation}
In other words, written in this form the `corner torque' for each node of the second magnet is given by
\begin{equation}\label{corner-torques}
  \bm \tau_{j,l,q} = \bm R_{j,l,q} \bm\times \bm f_{j,l,q}.
\end{equation}
It is easily seen that \eqref{torqu-1} and \eqref{torqu-2} are equivalent to \eqref{torque} since the inner summation in the former can be migrated out from inside the cross product.

The fallacy is that what has been referred until now as a corner force is in fact not actually a force; rather, it is simply a mathematical abstraction (a limit of an integral) that has no basis in the physics of the situation.
Using these corner forces to calculate the corner torques is simply not meaningful.
Indeed, it is not possible to reproduce the analytical results given by Allag and Yonnet in their paper.
Attempting to deduce our errors led us to discover that corner forces are not real, as will be shown below.

\subsection{Case study showing corner forces are not real forces}

Consider a system of two cube magnets with equal size and magnetisation, and displacement between them only in the vertical direction, with parameters given by
\begin{gather*}
a=b=c=A=B=C=0.005\,\text{m},\\
J_1=J_2=1\,\text{T},\\
[\alpha, \beta, \gamma]\T=[0, 0, 0.02\,\text{m}]\T .
\end{gather*}
These are the same parameters given as example by Allag and Yonnet.

Using \eqref{force} to calculate the resultant force on the second magnet gives
$F = [0, 0, -2.25\,\text{N}]\T$; this is the expected result since there is only vertical displacement and hence only vertical forces.

Using \eqref{torque} to calculate the resultant torque on the second magnet	gives
$T= [0.0074\, \text{N\,m}, -0.0074\, \text{N\,m}, 0]\T$.
As the magnet is in a force-symmetrical position, we do not expect there to be a torque in any direction.
Thus these calculated figures appear to be incorrect.

Using \eqref{torqu-2}, we can calculate each corner force on the second magnet to investigate from which terms these non-zero torques are appearing.
Looking only at the torque in the $y$-direction, we know it consists of force components in $x$ and $z$. That is, expanding the cross product of \eqref{corner-torques},
\begin{equation}\label{tau-y}
{\tau_y}_{|j,l,q} = {R_z}_{|j,l,q}\cdot {f_x}_{|j,l,q} -
  {R_x}_{|j,l,q}\cdot {f_z}_{|j,l,q} ~.
\end{equation}
We expect that summing ${\tau_y}_{|j,l,q}$ over $j,l,q\in\{0,1\}^3$ should yield zero but we know from the results above that this is not the case.
Summing the two terms of \eqref{tau-y} separately over the same ranges reveals that the first term (involving $f_x$) does indeed sum to zero but the second term (involving $f_z$) does not. Therefore, the problem lies in the calculation of the vertical corner forces.

Enumerating ${f_z}_{|j,l,q}$  in \tabref{corner-calc} shows the cause of the problem. For adjacent corners of the magnet, the corner forces are not symmetrical and hence result in the calculation of non-zero torques.
These results are calculated using a Matlab script that can be located online for verification.
\note{The Matlab script is located in `examples/allag\_torques.m' at \url{http://github.com/wspr/magcode}~.}

\begin{table}
\caption{Corner forces on the second magnet in the $z$-direction and their resultant corner torques.}
\figlabel{corner-calc}

\centering
\newcommand\0{\hphantom{0}}
\renewcommand\-{\makebox[0pt][r]{$-$}}
\newcolumntype{C}{>{$}c<{$}}
\newcolumntype{R}{>{$}r<{$}}
\begin{tabular}{@{}CCC@{}}
\toprule
(j,l,q) & {f_z}_{|j,l,q}\,\text{(N)} & {\tau_y}_{|j,l,q}\,\text{(N\,m)}\\
\midrule
(0, 0, 0) &  \-0.638 &  0.00319\0     \\
(1, 0, 0) &  0.187  &  0.000934     \\
(0, 1, 0) &  0.187  &  \-0.000934    \\
(1, 1, 0) &  1.01\0  &  0.00506\0     \\
(0, 0, 1) &  0.814  &  \-0.00407\0    \\
(1, 0, 1) &  \-0.749 &  \-0.00375\0    \\
(0, 1, 1) &  \-0.749 &  0.00375\0     \\
(1, 1, 1) &  \-2.31\0 &  \-0.0116\0\0    \\
\midrule
\multicolumn{1}{r}{\textsc{sum}} & \-2.251 & \-0.00739\0 \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Non-symmetric corner forces}

The expression \eqref{force} for calculating the corner forces contains the clues as to why non-symmetric forces are calculated, as seen above in \tabref{corner-calc}.
Writing the interaction between two corners as $(i,k,p)\to(j,l,q)$, consider two geometrically-symmetrical cases from the previous example with zero horizontal displacement:
\begin{itemize}
\item $(0,0,0)\to(1,0,0)$, and
\item $(1,0,0)\to(0,0,0)$.
\end{itemize}
These two interactions are depicted in \figref{mag-nodes}.

\begin{figure}[t]
\centering
\asyinclude{PhD/Figures/Magnets/mag-nodes}
\caption{Two geometrically-symmetrical node interactions.}
\figlabel{mag-nodes}
\end{figure}

The first term in \eqref{phi_z} is $-uv\log(r-u)$. All other terms will be the same since $v$, $w$, and $r$ are constant between the two cases in this example.
The term $u$, however, will switch signs; for the first case $u = -A-a$ and in the second case $u = A + a$. Accordingly, $\log(r - u)$ will have different magnitudes and so will $\phi_z$.
Corner forces are therefore not geometrically-symmetrical, and this is the first indication that they do not behave as real forces.

\subsubsection{Corner forces vs.\ distance}

Consider a fixed magnet of size $[2a,2b,2c]\T$ reacting with another magnet of some fixed vertical distance away. Compare two cases for the second magnet:
\begin{itemize}
\item	of equal size with $[2A, 2B, 2C]\T=[2a, 2b, 2c]\T$, and
\item	of greater size with $[2A, 2B, 2C]\T=[6a, 6b, 2c]\T$.
\end{itemize}
These two cases are shown in \figref{nodes-bigsmall} highlighting the interaction between two equivalent corners.

\begin{figure}
\centering
\asyinclude{PhD/Figures/Magnets/nodes-bigsmall}
\caption{Two node interactions for a smaller magnet and a larger magnet.}
\figlabel{nodes-bigsmall}
\end{figure}

In the second case with the larger magnet, there will be a larger distance between the corners of the magnets than in the first case.
And yet, because the magnet in the second case is larger the net force between the magnets will be larger, and the corner forces in the second case will be larger as well.
Obtaining greater forces with greater distances is a direct contradiction in the general behaviour of magnetic forces, which operate with an inverse relationship between force and displacement.
This is the second indication that corner forces are not real and should be not used to calculate torques.

In conclusion for this discussion of magnet nodes and their `corner forces', mathematical abstraction is not always helpful when trying to create mental models of a calculation based on the physics of the process.
The posited `corner force' of Bancel does not have a physical basis; using this force as if it were real leads to incorrect results.
We can only conclude that the original verification of the work by Allag and Yonnet is in error.


\section{Forces between orthogonal cuboid magnets}

Two groups of researchers simultaneously published, in the same journal, equivalent methods to calculate the force between orthogonal cuboid magnets \cite{janssen2009-sensorletters,allag2009-sensorletters}.
The expressions of \textcite{allag2009-sensorletters} are slightly simpler\footnote{Also note a typographical error in the equations of \textcite{janssen2009-sensorletters}.} and are reproduced here for completeness.
The signs of these equations has been reversed for consistency with \eqref{akoun} in which the equations calculate the force on the second magnet.

\begin{dmath}[label=orth-magforce]
\vect F_{z,y} = \frac{J_1J_2}{4\pi\mu_0} \sum_{i,j,k,l,p,q\in\{0,1\}^6} \vect f_{zy}\fn{\vect \delta}\cdot\gp{-1}^{i+j+k+l+p+q}
\end{dmath}
Again, the distance between the `corner nodes' of each magnet is given by
\begin{equation}
\vect\delta_{i,j,k,l,p,q}=\bm d+\bm R_{j,l,q} - \bm r_{i,k,p} ~,
\end{equation}
where
\begin{align}
\bm R_{j,l,q}&=\begin{bmatrix}A\gp{-1}^j\\B\gp{-1}^l\\C\gp{-1}^q\end{bmatrix},&
\bm r_{i,k,p}&=\begin{bmatrix}a\gp{-1}^i\\b\gp{-1}^k\\c\gp{-1}^p\end{bmatrix}.
\end{align}
with magnet dimensions defined as earlier.
The $\vect f_{zy}$ terms required for calculating the `force between nodes' for orthogonal magnets can now be written as:
\begin{dgroup}
\begin{dmath}
\phi_x\fn{\bm \delta} = vw\Log{r-u}-uv\Log{r+w}-uw\Log{r+v}+\half u^2\ArcTan{\frac{vw}{ru}}+\half v^2\ArcTan{\frac{uw}{rv}}+\half w^2\ArcTan{\frac{uv}{rw}}
\end{dmath},
\begin{dmath}
\phi_y\fn{\bm \delta} = -\half\gp{u^2-v^2}\log\fn{r+w}+uw\log\fn{r-u}+uv\arctan\fn{\tfrac{uw}{rv}}+\half rw
\end{dmath},
\begin{dmath}
\phi_z\fn{\bm \delta} = -\half\gp{u^2-w^2}\log\fn{r+v}+uv\log\fn{r-u}+uw\arctan\fn{\tfrac{uw}{rv}}+\half rv
\end{dmath}.
\end{dgroup}


\subsection{Examples}

The verification curve of the results of \textcite{akoun1984}, calculated using \eqref{total-force} with the `magnetforces' function, is shown in Figure~\ref{akoun} for the following system:
\begin{align}
\begin{split}
\bm s &=[\SI{20}{mm}, \SI{12}{mm}, \SI{6}{mm}]\T\\
\bm S &=[\SI{12}{mm}, \SI{20}{mm}, \SI{6}{mm}]\T\\
\bm d &=[\SI{-4}{mm}+\delta, \SI{-4}{mm}, \SI{8}{mm}]\T\\
\bm J_1,\bm J_2&=[0,0,\SI{0.38}{T}]\T
\end{split}
\end{align}

\begin{figure}
\begin{wide}
\begin{minipage}{0.45\linewidth}
\psfragfig{magcode/examples/fig/akoun-repro}
\caption{Reproduction of the results shown by \textcite{akoun1984}.}
\label{akoun}
\end{minipage}\hfill
\begin{minipage}{0.45\linewidth}
\psfragfig{magcode/examples/fig/janssen-repro}
\caption{Reproduction of the results of \textcite{janssen2009-sensorletters}.}
\label{janssen}
\end{minipage}
\end{wide}
\end{figure}


The verification curve of the results shown by \textcite{janssen2009-sensorletters} is shown in Figure~\ref{janssen} for the following system:
\begin{align}
\begin{split}
\bm s &=[\SI{10}{mm}, \SI{26}{mm}, \SI{14}{mm}]\T\\
\bm S &=[\SI{14}{mm}, \SI{26}{mm}, \SI{10}{mm}]\T\\
\bm d &=[\delta, \SI{-8}{mm}, \SI{15}{mm}]\T\\
\bm J_1 &=[0,0,\SI{1}{T}]\T,\qquad
\bm J_2=[\SI{1}{T},0,0]\T
\end{split}
\end{align}

The Matlab code to generate Figures \ref{akoun} and~\ref{janssen} is located in the file `examples/magnetforces\_example.m' (see Section~\ref{code}).


\section{Forces between cylindrical magnets}
\seclabel{cyl-forces}

Ravaud et al.~\cite{ravaud2010-ietm} recently published an expression for the forces between two cylindrical magnets or thin coils (which are equivalent electromagnetically). We have presented a simplification of their equation \parencite{robertson2011-ietm}.
This simplification results in a faster execution time and more convenient calculation with numerical software.

A reference implementation of the equations derived in this paper is available (\url{http://github.com/wspr/magcode}) for both Matlab and Mathematica; see respectively the files `ravaud-cylmag.m' and `ravaud-cylmag.nb' in the `examples/' directory.

In previous literature on modelling the forces between cylindrical magnets,
Nagaraj~\cite{nagaraj1988} investigated and compared the force between cuboid and cylindrical magnets with arbitrary displacements using numerical integration to calculate his results; Furlani~\cite{furlani1993-ietm,furlani1993-ietm-coupl} calculated the force between radially-aligned ring magnets using a numerical discretisation of the magnet volume using theory developed in more detail in his book~\cite{furlani2001-magnetbook}. Hull et al.~\cite{hull1999-japplphys} presented integral equations for calculating the radial and axial forces between a cylindrical magnet and a superconductor, which is equivalent to the force between two cylindrical magnets, and \textcite{bassani2006-trib-int} presented integral equations for calculating the radial and axial forces between ring magnets. Such integral equations require numerical methods to evaluate.
Most recently, \textcite{ravaud2010-ietm} derived a closed-form solution using elliptic integrals for the forces between radially-aligned cylindrical magnets; their result is the most straightforward method yet presented for calculating forces in this configuration.

\begin{figure}
\centering
\asyinclude{PhD/Figures/Coil/coil-mag-equiv.asy}
\caption{The equivalence between a permanent magnet of magnetisation $J$ (left) in the positive vertical direction, and a current-carrying coil (right) with equivalent magnetisation $J_{\text{eq.}}=\mu_0 N I/h$ for current $I$ shown flowing anti-clockwise from the top through $N$ axial turns across height $h$.}
\figlabel{coil-mag-equiv}
\end{figure}

The equation for the force between cylindrical magnets can also be used to calculate the force between thin coils with many axial turns, as both magnet and coil can be modelled as a surface current density around a cylinder (see Fig.\,\ref{fig:coil-mag-equiv}). In related work, Kim et al.~\cite{kim1996-ietm} presented a different integral equation for the radial force between (single-turn) circular coils with eccentric radial displacement, for which further application of their results is required to calculate the forces between coils with many turns, such as for the system examined here. An expression for the force between thin coaxial coils has also been published by Babic et al.~\cite{babic2008-ietm}; it too is more complex than the expression to be presented in the current work.

The equation of Ravaud et al.~\cite{ravaud2010-ietm} is suitable for use for magnets or coils of any size with no restriction on axial displacement. For magnets, they are assumed to have constant magnetisation that is strong enough such that adjacent magnets will not affect the magnetisation of each other. For coils, they are modelled as surface current densities only; therefore for accurate coil calculations the radial thickness of the coil must be much smaller than its radius and the coil must be wound tightly in the axial direction. The force between thick coils with many radial turns has been shown also by Ravaud~et al.~\cite{ravaud2010-pier}; this expression requires some numerical integration and is accordingly slower to calculate than the expression for thin coils discussed herein.

The system consists of two coaxial cylindrical magnets or current-carrying coils which have a relative axial displacement between them, as shown in Fig.\,\ref{fig:cyl-schem}.
A three-dimensional schematic is shown later in Fig.\,\ref{fig:coil-param} that also illustrates the equivalence between a magnet and a coil in this system.

\begin{figure}
\centering
\asyinclude{PhD/Figures/Systems/cyl.asy}
\caption{Two-dimensional side view of the system composed of two coaxial cylindrical magnets with a generated force on the second magnet. (While magnets are shown, either or both may be replaced by a thin coil as shown in Fig.\,\ref{fig:coil-mag-equiv}.) Axial displacement between the magnets may be positive or negative, and their volumes may overlap in the case of a magnet located inside a coil. Arrows within the magnets indicate direction of magnetic polarisation.}
\figlabel{cyl-schem}
\end{figure}

\def\m#1{m_{#1}}
The force equation is given by
\begin{dmath}[label=simpl4]
F_z = \frac{J_1 J_2}{2\mu_0} \sum_{i=1}^2 \sum_{j=3}^4 \m1\m2\m3 f_z' \gp{-1}^{i+j}
\end{dmath},
where the intermediate expression is
\begin{dmath}[label=simpl4i]
f_z'=
  \EllipticK{\m4}
  - \frac{1}{\m2}\EllipticE{\m4}
  +
\gdef\finalterm{
  \gp[2]{\frac{\m1^2}{\m3^2}-1} \invtimes
    \EllipticPi{\frac{\m4}{1-\m2},\m4}
}
\finalterm
\end{dmath},
with parameters
\begin{align}
\m1 &= z_i - z_j, \\
\m2 &= \frac{\gp{r_1-r_2}^2}{\m1^2}+1,\\
\m3^2 &= \gp{r_1+r_2}^2+\m1^2, \\
\m4 &= \frac{4 r_1 r_2}{\m3^2}, \qquad 0<\m4\le 1.
\end{align}

As a result of the simplifications presented here, equation~\eqref{simpl4} contains one-third the number of terms compared to the original equation (three instead of nine) and is defined in terms of four instead of ten parameters. Additionally, the complete elliptic integrals of the first, second, and third kind can all be calculated simultaneously with a single iteration of the arithmetic-geometric mean approach \cite[\S19.8(i)]{DLMF2010}, as they all take the same parameter $\m4$. This makes equation~\eqref{simpl4i} particularly efficient to implement.

\subsection{Numerical evaluation of the axial force}
\label{sec:numer}

Numerical singularities occur when an expression is mathematically continuous but terms within the expression approach infinity; care must be taken when evaluating such expressions numerically.
There are two numerical singularities in equation~\eqref{eq:simpl4}.
The first occurs when the radii are equal such that $\m2=1$ and the following term disappears as $\EllipticPi{\pm\infty,m}=0$:
\begin{dmath}
\finalterm = 0 \condition*{\m2=1}
\end{dmath}.

The second numerical singularity occurs when the magnets/coils have coincident faces such that $\m1=0$ for some values of $i$ and $j$ in the double summation. In this case, the parameter $\m2$ contains the coefficient $1/\m1^2=1/0$. This singularity can be avoided entirely since coincident faces generate no component of force between them, and hence the entire intermediate expression within the summation $\m1\m2\m3 f_z'$ can be defined as zero when $\m1=0$.

\subsection{Implementation efficiency}

Evaluated in Mathematica (including branching to avoid singularities), \eqref{eq:simpl4} took an average of 0.26\,ms on a notebook computer to calculate the force at a single location (10000 samples with random input variables). The original equation by \citeauthor{ravaud2010-ietm} in the same configuration evaluated in 2.2\,ms on average, which is over eight times slower than the new equation. For researchers performing design optimisations with variations over a large number of parameters, such an efficiency improvement is useful in minimising the total computation time of the optimisation process.

\subsection{Example}

The equivalence of the simplified equation is demonstrated with an example in which a magnet of length $h_2=z_4-z_3$ is located axially centred within a coil of length $h_1=z_2-z_1$  and displaced in equal amounts in the positive and negative axial directions. That is, axial displacement $\displ$ between the centres of the magnet and the coil is defined as
\begin{dmath}
\displ=\half\gp{z_3+z_4}-\half\gp{z_1+z_2}
\end{dmath}.
Fig.\,\ref{fig:coil-param} shows the parameters used in the simulations and
Fig.\,\ref{fig:ex1} displays the respective outputs calculated with the old equation using Mathematica and the new equation using Matlab.
These calculations are performed in the example files mentioned in Section~\ref{sec:intro}.

In the simulation results, the magnet experiences zero force when it is axially centred inside the coil. With axial displacement, a restoring force is applied by the coil in the opposite direction of displacement. As shown in Fig.\,\ref{fig:ex1}, the results are identical for both the original and the simplified equations.

\begin{figure}
\centering
\hspace{-4cm}\asyinclude{PhD/Figures/Coil/coil-coil.asy}\hspace{-2cm}%
  \begin{tabular}[b]{@{}ll@{}}
  \toprule
  $r_1$ &   \SI{20}{mm} \\
  $h_1$ &   \SI{20}{mm} \\
  $J_1$ & $\mu_0NI/h_1$ \\
  $N$ & $100$ \\
  $I$ & \SI{1}{A} \\
  \midrule
  $r_2$ & \SI{15}{mm} \\
  $h_2$ & \SI{15}{mm} \\
  $J_2$ & \SI{1}{T}\\
  \bottomrule
  \end{tabular}
\caption{Parameters used for the example calculations with results shown in Fig.\,\ref{fig:ex1}. The schematic indicates the direction of current flow and the north and south faces of the magnet. A position of positive displacement $z$ is shown.}
\figlabel{coil-param}
\end{figure}


\begin{figure}
  \centering
  \begin{tikzpicture}
    \begin{axis}
      [
        xlabel={Displ.\ $\displ$, mm},
        ylabel={Axial force $F_z$, N},
        xtick={-40,-20,20,40},
        xticklabels = {\llap{$-$}$40$,\llap{$-$}$20$,$20$},
        ytick={-1,-0.5,0.5,1},
        yticklabels = {$-1$,$-0.5$,,$1$},
        axis x line=center,
        axis y line=center,
        legend cell align=left,
        legend entries = {New, Old},
        legend style = {
          legend pos = south west,
        },
      ]
      {
        \draw (axis cs:-50,0) -- (axis cs:50,0);
        \draw (axis cs:0,-1.4) -- (axis cs:0,1.4);
        \addplot+[only marks,mark=diamond*,mark options={fill=white},
,color=black] file {magcode/examples/data/magcyl-matlab.txt};
        \addplot[style=thick,color=red] file {magcode/examples/data/magcyl-mma.txt};
      }
    \end{axis}
  \end{tikzpicture}
  \caption{An example of the force generated on a cylindrical magnet by a coil with parameters defined in Fig.\,\ref{fig:coil-param}. Displacement is defined as zero when the coil and magnet are axially centred with respect to each other. The new equation is implemented in Matlab vs the old equation in Mathematica to ensure the two are numerically equivalent.}
  \figlabel{ex1}
\end{figure}


%%%%%%%%%%%%%%

\section{Simplified force and stiffness expression for cube magnets}
\secref{cube-forces}

The function $\nforce$ is the simplication of \eqref{akoun}
formula after the assumptions given in \secref{mag}, where $J_1$ and
$J_2$ are the magnetisations of the two magnets and
$\permVac=4\pi\times10^{-7}$ is the `permeability of the vacuum':
\begin{dmath}[label=nforce]
  \nforce = \frac{J_1J_2}{\pi\permVac} \baraccent{\nforce}
\end{dmath}
where
\begin{dmath}
  \baraccent{\nforce} = \gp{-2+\ndisp}\cdot\Abs{-2+\ndisp}-2 \ndisp \Abs{\ndisp}+\gp{2+\ndisp}\cdot
  \Abs{2+\ndisp}+4 \ndisp \sqrt{4+\ndisp^2}
  -2 \ndisp \sqrt{8+\ndisp^2}+\gp{4-2 \ndisp} \sqrt{8-4
    \ndisp+\ndisp^2}+\gp{-2+\ndisp} \sqrt{12-4 \ndisp+\ndisp^2}
  +\gp{-4-2 \ndisp} \sqrt{8+4 \ndisp+\ndisp^2}+\gp{2+\ndisp}
  \sqrt{12+4 \ndisp+\ndisp^2}
  +2 \left[ 4 \mathatan\left[\frac{4}{\ndisp \sqrt{8+\ndisp^2}}\right]+2
    \mathatan\left[\frac{4}{\gp{2-\ndisp}
        \sqrt{12-4 \ndisp+\ndisp^2}}\right]\right.
  -2 \mathatan\left[\frac{4}{\gp{2+\ndisp} \sqrt{12+4 \ndisp+\ndisp^2}}\right]+2 \ndisp
  \mathlog\left[-2+\sqrt{4+\ndisp^2}\right]
  -2 \ndisp \mathlog\left[2+\sqrt{4+\ndisp^2}\right]-2 \ndisp
  \mathlog\left[-2+\sqrt{8+\ndisp^2}\right]
  +2 \ndisp \mathlog\left[2+\sqrt{8+\ndisp^2}\right]+2
  \mathlog\left[-2+\sqrt{8-4
      \ndisp+\ndisp^2}\right]
  -\ndisp \mathlog\left[-2+\sqrt{8-4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[2+\sqrt{8-4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[2+\sqrt{8-4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[-2+\sqrt{12-4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[-2+\sqrt{12-4 \ndisp+\ndisp^2}\right]+2
  \mathlog\left[2+\sqrt{12-4 \ndisp+\ndisp^2}\right]
  -\ndisp \mathlog\left[2+\sqrt{12-4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[-2+\sqrt{8+4 \ndisp+\ndisp^2}\right]
  -\ndisp \mathlog\left[-2+\sqrt{8+4 \ndisp+\ndisp^2}\right]+2
  \mathlog\left[2+\sqrt{8+4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[2+\sqrt{8+4 \ndisp+\ndisp^2}\right]+2
  \mathlog\left[-2+\sqrt{12+4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[-2+\sqrt{12+4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[2+\sqrt{12+4 \ndisp+\ndisp^2}\right]
  \left.  -\ndisp \mathlog\left[2+\sqrt{12+4 \ndisp+\ndisp^2}\right]\right]
\end{dmath}

The normalised stiffness $\nstiffness$ is calculated by differentiating the force equations given by \textcite{akoun1984} before simplifying as with the force terms above:
\begin{dmath}[label=nstiffness]
  \nstiffness = -\frac{2J_1J_2}{\pi\permVac} \baraccent{\nstiffness}
\end{dmath}
where
\begin{dmath}
  \baraccent{\nstiffness} = \Abs{-2+\ndisp}-2 \Abs{\ndisp}+\Abs{2+\ndisp}+4
  \sqrt{4+\ndisp^2}-2\sqrt{8+\ndisp^2}
  -2 \sqrt{8-4 \ndisp+\ndisp^2}+\sqrt{12-4 \ndisp+\ndisp^2}-2 \sqrt{8+4\ndisp+\ndisp^2}
  +\sqrt{12+4 \ndisp+\ndisp^2}+2 \mathlog\left[-2+\sqrt{4+\ndisp^2}\right]
  -2\mathlog\left[2+\sqrt{4+\ndisp^2}\right]
  -2\mathlog\left[-2+\sqrt{8+\ndisp^2}\right]
  +2\mathlog\left[2+\sqrt{8+\ndisp^2}\right]
  -\mathlog\left[-2+\sqrt{8-4 \ndisp+\ndisp^2}\right]
  +\mathlog\left[2+\sqrt{8-4\ndisp+\ndisp^2}\right]
  +\mathlog\left[-2+\sqrt{12-4\ndisp+\ndisp^2}\right]
  -\mathlog\left[2+\sqrt{12-4\ndisp+\ndisp^2}\right]
  -\mathlog\left[-2+\sqrt{8+4 \ndisp+\ndisp^2}\right]
  +\mathlog\left[2+\sqrt{8+4\ndisp+\ndisp^2}\right]
  +\mathlog\left[-2+\sqrt{12+4\ndisp+\ndisp^2}\right]
  -\mathlog\left[2+\sqrt{12+4 \ndisp+\ndisp^2}\right]
\end{dmath}


\subsection{Arbitary magnetisations}

Most force expressions are derived from magnetic field equations that are assumed from magnets with magnetisation parallel to one of their sides.
Superposition can then be used to combine the expressions for orthonogal magnets to generate the force from a magnet with arbitrary magnetisation.
\textcite{ravaud2009-pier98} instead show the magnetic field equations for a cuboid magnet with arbitrary magnetisation; their work is still to be extended to calculate the forces between such magnets.
Since their equation for calculating the magnetic field is necessarily more complex, it is not clear whether an equation derived using analytical integration to calculate the force directly (if the integral is even tractable) will be more efficient than the superposition approach outlined below.

The geometry of the two-magnet system is shown in Figure~\ref{diagram}, in which the magnets have side lengths $\bm s = [2a, 2b, 2c]\T$ and $\bm S = [2A, 2B, 2C]\T$ respectively and the distance between their centres is given by $\bm d=[\alpha,\beta,\gamma]\T$. The calculations always assume that the first magnet is fixed and force is acting on the second magnet. The signs must be reversed to obtain the forces acting on the first magnet.

As shown earlier in \eqref{akoun},
\textcite{akoun1984} provide the force expressions for magnets with vertical magnetisations.
This force is denoted below as $\bm F_{z,z}\fn{\bm s, \bm S, \bm d, J_1, J_2}$ as a function of the magnet sizes, the distance between them, and their magnetisation magnitudes $J_1$ and $J_2$.
From \eqref{orth-magforce}, \textcite{allag2009-electromotion} provide the force expressions for the first magnet with vertical magnetisation and the second magnet with magnetisation in the horizontal $y$-direction.
This force is denoted below as $\bm F_{z,y}\fn{\bm s, \bm S, \bm d, J_1, J_2}$.

The force between a vertically-magnetised magnet and one with magnetisation in the horizontal $x$-direction can be calculated by applied a rotational transformation to $\bm F_{z,y}$ around the $z$-axis.
That is,
\begin{equation}\eqlabel{fzx}
\bm F_{z,x}\fn{\bm s, \bm S, \bm d, J_1, J_2} = \mathbf R_z\fn{-\tfrac{\pi}2}\bm F_{z,y}\fn{\bm s_{z,x}, \bm S_{z,x},\bm d_{z,x}, J_1, J_2} ,
\end{equation}
where
\begin{align}
\bm s_{z,x} &= \Abs{\mathbf R_z\fn{\tfrac\pi2}\bm s}, \\
\bm S_{z,x} &= \Abs{\mathbf R_z\fn{\tfrac\pi2}\bm S}, \\
\bm d_{z,x} &= \mathbf R_z\fn{\tfrac\pi2}\bm d,
\end{align}
for which $\Abs{\cdot}$ is the \emph{element-wise} absolute value function and $\mathbf R_z\fn{\theta}$ is the rotation matrix around the $z$-axis:
\begin{equation}
\mathbf R_z\fn\theta = \begin{bmatrix}
\cos\theta & -\sin\theta & 0 \\
\sin\theta & \hphantom{-{}}\cos\theta & 0 \\
0 & 0 & 1
\end{bmatrix}.
\end{equation}

Using the force expressions $\bm F_{z,x}$, $\bm F_{z,y}$, and $\bm F_{z,z}$ in superposition allow the force to be calculated between a vertically magnetised magnet and another magnet with arbitrary magnetisation direction. By applying coordinate system transformations to these expressions, arbitrary magnetisation directions can be achieved for the first magnet as well.

For horizontal $x$-direction magnetisation,
\begin{equation}\eqlabel{fxxyz}
\bm F_{x,\{x,y,z\}}\fn{\bm s, \bm S, \bm d, J_1, J_2} =
  \mathbf R_y\fn{\tfrac\pi2}
  \bm F_{z,\{x,y,z\}}\fn{\bm s_x, \bm S_x, \bm d_x, J_1, J_2}
\end{equation}
where
\begin{align}
\bm s_x &= \Abs{\mathbf R_y\fn{-\tfrac\pi2}\bm s}, \\
\bm S_x &= \Abs{\mathbf R_y\fn{-\tfrac\pi2}\bm S}, \\
\bm d_x &= \mathbf R_y\fn{-\tfrac\pi2}\bm d,
\end{align}
and $\mathbf R_y\fn{\theta}$ is the rotation matrix around the $y$-axis:
\begin{equation}
\mathbf R_y\fn\theta = \begin{bmatrix}
\cos\theta & 0 & -\sin\theta \\
0 & 1 & 0 \\
\sin\theta & 0 & \hphantom{-{}}\cos\theta \\
\end{bmatrix}.
\end{equation}
Similarly, for horizontal $y$-direction magnetisation,
\begin{equation}\eqlabel{fyxyz}
\bm F_{y,\{x,y,z\}}\fn{\bm s, \bm S, \bm d, J_1, J_2} = \\
  \mathbf R_x\fn{-\tfrac\pi2}
  \bm F_{z,\{x,y,z\}}\fn{\bm s_y, \bm S_y, \bm d_y, J_1, J_2}
\end{equation}
where
\begin{align}
\bm s_y &= \Abs{\mathbf R_x\fn{\tfrac\pi2}\bm s}, \\
\bm S_y &= \Abs{\mathbf R_x\fn{\tfrac\pi2}\bm S}, \\
\bm d_y &= \mathbf R_x\fn{\tfrac\pi2}\bm d,
\end{align}
and $\mathbf R_x\fn{\theta}$ is the rotation matrix around the $x$-axis:
\begin{equation}
\mathbf R_x\fn\theta = \begin{bmatrix}
1 & 0 & 0 \\
0 & \cos\theta & -\sin\theta \\
0 & \sin\theta & \hphantom{-{}}\cos\theta \\
\end{bmatrix}.
\end{equation}

Given the results of the afore-referenced papers by Yonnet et al. and \eqref{fzx,fxxyz,fyxyz}, the force between two magnets of arbitrary magnetisation can be written as
\begin{equation}\eqlabel{total-force}
\bm F\fn{\bm s, \bm S, \bm d,\bm J_1,\bm J_2}=\sum_{i,j\in\{x,y,z\}^2} \bm F_{i,j}\fn{\bm s, \bm S, \bm d, J_{1_i}, J_{2_j}}
\end{equation}
where
\begin{align}
\bm J_1 &= [J_{1_x},J_{1_y},J_{1_z}]\T, &
\bm J_2 &= [J_{2_x},J_{2_y},J_{2_z}]\T.
\end{align}
Although it is well known that the principle of superposition can be used in this way,
this is the first formalisation of this theory to decompose a diagonal magnetisation into its orthogonal components for calculating the forces between diagonally-polarised magnets.



\subsection{Other approaches}

To account for magnets that do not have parallel/anti-parallel
magnetisation, \textcite{chen2002,chen2003} derived an expression in two
dimensions for the force induced between two L-shaped current
sheets, then applies this model with the length
of various legs of the `L' in different configurations set to zero. This
takes the assumption, like \textcite{yonnet1981}, of infinitely long
planar cross sections.
This was suitable for application to a magnetic bearing where
the curvature of the magnet has a small or negligible effect on the
force between the magnets. However, for true three dimensional cases
(such as the forces between two cube magnets) this technique would not
be suitable.

Rotation of a magnet around an axis is treated by Eliès, Charpentier and
Lemarquand in numerous papers
\cite{elies1998,charpentier1999-ietm-mar,charpentier1999-ietm-sep,elies1999a}, giving equations
for the forces in the directions other than around which the magnet is
rotated. Since the equations they present are not self-consistent (some typing
mistakes have occurred in the publications of the papers), the correct form is
printed in \secref{french-equations} in an easier to read, abbreviated form.

\textcite{nagaraj1988} derived integrals using the current method
\fxfatal{crossref} to calculate the forces between cuboid magnets and
between cylindrical magnets, and compared the differences in
behaviour.

More complex behaviours, however, cannot be solved analytically as the
integrals become untractable; for anything approaching the forces
between two magnets with arbitrary rotations, \emph{numerical}
integration must be used \cite{elies1999a}. This technique is capable
of obtaining results in a much more straightforward manner than finite
element analysis, and must be used for the more complex situations.

\subsection{Forces between magnets with relative rotation}
\seclabel{french-equations}

In 1999, a slew of papers were published by researchers at \emph{Laboratoire
d'Electrotechnique et de Magnétisme de Brest} investigating the forces between
non-contact magnetic rotational force couplers. These are of interest to this
work because they use an analytical expression for the forces between two
cuboidal magnets under arbitrary translation, with one inclined at any angle
around the \x-axis.

Incidentally, there's nothing special about this particular integral; it's the
same one used by Bancel in his Magnetic Nodes paper. You kind of need a
picture, and I don't like the notation, but:
\begin{dmath}
  \magB_1 =
    \iint_{S_{1+}}
      \frac{J}{4\pi}
      \frac{\vect{P}_{S_{1+}}\vect{P}}
           {\overline{P_{S_{1+}}P}^3}
    \dee{S_{1+}}
    -
    \iint_{S_{1-}}
      \frac{J}{4\pi}
      \frac{\vect{P}_{S_{1-}}\vect{P}}
           {\overline{P_{S_{1-}}P}^3}
    \dee{S_{1-}},
  \\
  \vect{F} =
    \iint_{S_{2+}}
      \frac{J}{\permVac}\magB_1
    \dee{S_{2+}}
    -
    \iint_{S_{2-}}
      \frac{J}{\permVac}\magB_1
    \dee{S_{2-}}.
\end{dmath}
This is different to the work of \textcite{akoun1984}, who derive an
expression for the interaction energy between the two magnets and then
differentiate to get the forces.

These expressions follow the work of \textcite{bancel1999}, who defined his
equations as a set of nested functions, unlike the equations of
\textcite{akoun1984} that were six-nested summations. Back to these new
papers, three were published \cite{elies1998,charpentier1999-ietm-mar,charpentier1999-ietm-sep}
that all contain the expression I am interested in (why didn't they just cite
the original?), with a fourth \cite{elies1998} containing just the force
expression in a single direction. There's a little bit extra in the paper by
\cite{elies1999a} that looks at the forces of two magnets inclined around the
vertical axis, calculated with a numerical integration. The final paper
\cite{elies1999} involves couplings exclusively, making it less applicable to
this work. Its inclusion here is for completeness.

Their equations are re-written here for each separate publication contains different typographical errors.
The equations here have been reconstructed by comparing the differences and similarities between the equations in the different papers, and re-written in a more compact form.
Given two magnets located
in \threeD/ space, of sizes $\inlinevect{A,B,C}$ and $\inlinevect{a,b,c}$,
with the plane of the second rotated by $\theta$ around the \x-axis and their
origins offset by $\inlinevect{x_0,y_0,z_0}$, the forces in the \y- and
\z-directions ($F_y$ and $F_z$) between the two magnets can be calculated.

Forces in both the $y$ and $z$ direction use the $f_3$ function in
their calculations.
\begin{dmath}
F_y = \frac{J^2}{4\pi\permVac}
  \sum_{i_{a,b,c,A,B,C}\in\{0,1\}}
  f_{y_2}\cdot\gp{-1}^{i_a+i_b+i_c+i_A+i_B+i_C}
\end{dmath},
\begin{dmath}
F_z\bigg|_{\theta\neq k\pi} =
       \frac{-J^2}{4\pi\permVac}\cdot\smash{\sum_{i_{a,b,c,A,B,C}\in\{0,1\}}}
        f_{z_2}\cdot\gp{-1}^{i_a+i_b+i_c+i_A+i_B+i_C}
\end{dmath},
\begin{dmath}
f_{y_2} = f_3\fn{u_0 , y_0 , z_0 , \theta , c i_c , C i_C}
\end{dmath},
\begin{dmath}
f_{z_2} =  \frac{f_3\fn{u_1,v_1,w_1,-\theta,0,0}}{\sin\theta}
         + \frac{f_3\fn{u_2,v_2,w_2,\theta,0,0}}{\tan\theta}
\end{dmath},
\begin{dgroup}
\begin{dmath}
u_0 = x_0 - ai_a + Ai_A
\end{dmath},
\begin{dmath}
u_1 = u_0-2x_0
\end{dmath},
\begin{dmath}
v_1 = -v_2\cos\theta - w_2\sin\theta
\end{dmath},
\begin{dmath}
w_1 = v_2\sin\theta - w_2\cos\theta
\end{dmath},
\begin{dmath}
v_2 = y_0-Ci_C\sin\theta
\end{dmath},
\begin{dmath}
w_2 = z_0-ci_c+Ci_C\cos\theta
\end{dmath}.
\end{dgroup}
This is the auxiliary function used in the above. All dashed variables are
local to this function.
\begin{dgroup*}
\begin{dmath}
f_3\fn{u',v',w',\theta',c',C'} =
  u' f_5\gp{\Log{f_4-u'}-1}
  +\half\gp{f_6^2-{u'}^2}\Log{f_4+f_5}
  +\half u' \pi \Sign{f_5}\Abs{f_6}
  +u' f_6 \ArcTan{\frac{u' f_4 - u^2 -f_6^2}{f_5 f_6}}
  +\half f_4 f_5
\end{dmath},
\begin{dmath}
f_4 = \sqrt{{u'}^2+f_5^2+f_6^2}
\end{dmath},
\begin{dmath}
f_5 = \gp{v'-b i_b}\cos\theta'+\gp{w'-c'}\sin\theta'+B i_B
\end{dmath},
\begin{dmath}
f_6 = -\gp{v'-b i_b}\sin\theta'+\gp{w'-c'}\cos\theta'+C'
\end{dmath}.
\end{dgroup*}

The force in the $z$ direction is calculated separately if the second
magnet is not rotated around its axis ($f_{z_2}$ has a singularity
at $\theta=k\pi$).
\begin{dgroup}
\begin{dmath}
F_z\bigg|_{\theta=k\pi} =
  \cos\theta\cdot\frac{-J^2}{4\pi\permVac}
  \sum_{i_{a,b,c,A,B,C}\in\{0,1\}}f_{z_1}
  \cdot\gp{-1}^{i_a+i_b+i_c+i_A+i_B+i_C}
\end{dmath},
\begin{dmath}
f_{z_1} =
  \half uw\Log{\frac{r+u}{r-u}}+\half vw\Log{\frac{r+v}{r-v}}+
  uv\ArcTan{\frac{uv}{wr}-wr}
\end{dmath},
\begin{dmath}
u = x_0-ai_i+Ai_A
\end{dmath},
\begin{dmath}
v = y_0-bi_b+Bi_B+\half B\gp{\cos\theta-1}
\end{dmath},
\begin{dmath}
w = z_0-ci_c+Ci_C+\half C\gp{\cos\theta-1}
\end{dmath},
\begin{dmath}
r = \sqrt{u^2+v^2+w^2}
\end{dmath}.
\end{dgroup}

This equation is very similar, but not identical, to Akoun~\& Yonnet's
equation for the same thing. I suspect theirs is more simple because they
integrate over symmetric limits of integration (\eg, $\int^{+a}_{-a}$). Terms
that are odd functions integrate to zero in this case.

In order to allow this equation to be used for rotations greater than
\SI{\sipi}{radians}, additional terms have been added to accommodate for the
translational offset induced by rotating the magnet around its lower-left
edge. The preceding $\cos\theta$ provides the sign change of the
magnetisation, and the $\half\gp{\cos\theta-1}$ terms are used to return the
origin of the magnet after 180\textdegree\ rotation to the lower-left corner,
where it is expected.

As an example of using these equations to calculate forces as a function of magnet rotation, \figref{charp-rotate} shows the forces produced between two \SI{10}{mm} cube magnets as a function of rotation angle $\theta$ of the second magnet, with a \SI{20}{mm} offset between their centres.
Two cases are shown: in the first , the magnets are displaced vertically; in the second, the magnets are displaced horizontally.

\begin{figure}
  \begin{wide}
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-rotation-forces}
    \caption{Vertical displacement.}
  \end{subfigure}
  \hfil
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-horiz-rotation-forces}
    \caption{Horizontal displacement.}
  \end{subfigure}
  \hfil
  \null
  \end{wide}
  \caption{Vertical and horizontal forces on a rotating magnet
    as a function of rotation angle for fixed horizontal and vertical displacements.}
  \figlabel{charp-rotate}
\end{figure}

\Figref{charp-rotate} shows that the maximum force between two magnets is
exhibited when the direction of displacement is in the same direction as their
magnetisations. For displacements perpendicular to the direction of
magnetisation of the fixed magnet, forces of equal magnitude are obtained for
rotation of the second magnet $\theta=k\pi/2$ for $k\in\{0,1,2,\dots\}$.

\fxfatal{cross ref yonnet (?) old result for bearings having same force}

In the following simulations, the second magnet is held at a constant height (one magnet height's separation distance) and moved from left to right over a range of twice the magnet width symmetrically above the first magnet (with respect to the magnets' centres of gravity).
Four such displacements are made with four different rotations for the second magnet: $0$, $\half\pi$, $\pi$ and $-\half\pi$.
\Figref{charp-0to2pi} shows the forces in the horizontal \y-direction and vertical \z-direction, \resp.
It can be seen that the opposite rotations result in symmetric forces curves, as is expected.

\begin{figure}
  \begin{wide}
  \hspace{-1cm}%
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-0to2pi-Fy}
    \caption{Horizontal forces.}
    \figlabel{charp-0to2pi-Fy}
  \end{subfigure}\hfil
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-0to2pi-Fz}
    \caption{Horizontal forces.}
    \figlabel{charp-0to2pi-Fy}
  \end{subfigure}
  \end{wide}
  \caption{Vertical and horizontal forces on a rotating magnet situated directly above another.}
  \figlabel{charp-0to2pi}
\end{figure}


\section{Future work}

The code presented here currently only contains algorithms for calculating forces and stiffnesses between cuboid magnets without rotation. \textcite{charpentier1999-ietm-sep} present expressions for two components of the force between cuboid magnets with rotation around one axis (also see their related publications around the same time), but there is no general solution known without using semi-numerical methods \parencite{charpentier2001}.


\textcite{janssen2009-ietm} have derived the analytical forces between pyramidal-frustrum shaped magnets, which have not quite yet been published at time of writing. 


\section{Reproducible research}

Some of the results presented in this thesis are reproducible \parencite{kovacevic2007-icassp} with code located at \url{http://www.github.com/wspr/magcode}. This is a software implementation in both Matlab and Mathematica  of much of the above theory for calculating the forces between magnets and multipole arrays of magnets, and is freely available to be used by the public.

This code is written to provide a convenient interface to the theory presented above.

Blah blah blah.

